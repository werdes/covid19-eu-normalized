function load(){switch($("#loading-indicator").removeClass("d-none"),$("#threshold-cases").text($("#field-threshold-cases").val()),$("#threshold-deaths").text($("#field-threshold-deaths").val()),$("#days-before-threshold").text($("#field-days-before-threshold").val()),setHideButton("hide"),$("input[name=source]:checked").val()){case"johns-hopkins-csse-confirmed":loadJHCSSEConfirmed(displayData);break;case"johns-hopkins-csse-deaths":loadJHCSSEDeaths(displayData)}}function displayData(e,t,a,o){var r=new Array,n=null,s=[],i=parseInt($("#field-days-before-threshold").val()),l=$("input[type=radio][name=sorting]:checked").val(),c=$("input[type=radio][name=source-value]:checked").val(),d=$("input[type=radio][name=source-scaling]:checked").val();n=t.subtract(i,"days"),console.log(t+" -> "+n),Object.keys(e).forEach(function(t){s.push(e[t])}),s.sort(function(e,t){return"alphabetical"==l?e.country.replace('"',"").localeCompare(t.country.replace('"',"")):t.fullCaseCount-e.fullCaseCount}),s.forEach(function(e,t){if(e.reachedThreshold){var a=new Array,s=null;Object.keys(e.byDay).forEach(function(t){var r,i,l=moment(t,"YYYY/MM/DD"),h=moment.duration(l.diff(e.reachedThresholdAt,"days")),u=moment(t,"YYYY/MM/DD").subtract(e.dayDiffToLowest,"days");"relative"==d?(i=null==s?null:e.byDayRelative[t]-s,r=e.byDayRelative[t],"new"==c&&(r=i)):(i=null==s?null:e.byDay[t]-s,r=e.byDay[t],"new"==c&&(r=i)),u>=n&&a.push({x:u.toDate(),real:l,daysSinceStart:h,region:e,dataType:o,y:r,addedFromLast:i,sourceScaling:d,total:e.byDay[t]}),s="relative"==d?e.byDayRelative[t]:e.byDay[t]}),r.push({name:e.country,color:e.country.toColor(),data:a})}}),$("#loading-indicator").addClass("d-none"),Highcharts.chart("chart",getChartOptions(a,r,o))}function loadJHCSSEConfirmed(e){var t=parseInt($("#field-threshold-cases").val());loadJHCSSE(e,"https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv","cases",t)}function loadJHCSSEDeaths(e){var t=parseInt($("#field-threshold-deaths").val());loadJHCSSE(e,"https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv","deaths",t)}function loadJHCSSE(e,t,a,o){var r=null,n=null,s="([0-9]{1,2}/[0-9]{1,2}/[0-9]{1,2})\\w+",i={};$("input[type=radio][name=source-scaling]:checked").val();$.get({url:"data/un_populationdata.csv",cache:!0,complete:function(l){l=csvToArray(l.responseText,";"),l.shift();var c={};l.forEach(function(e){c[e[0]]=parseInt(e[1])}),$("body").append("<textarea>"+JSON.stringify(c)+"</textarea>"),$.get({url:t,cache:!0,complete:function(t){var l=csvToArray(t.responseText),d={},h=l[0];h.forEach(function(e,t){if(e.match(s)){var a=moment(e),o=a.format("YYYY/MM/DD");d[o]=t}}),l.shift(),l.forEach(function(e,t){var a=e[1];if(null!=a){if(!i[a]){var o=null;c[a]&&(o=c[a]),i[a]={country:a,reachedThresholdAt:null,reachedThreshold:!1,dayDiffToLowest:0,fullCaseCount:0,population:o,byDay:{},byDayRelative:{}}}var r=i[a];Object.keys(d).forEach(function(t){var a=d[t],o=parseInt(e[a]);r.byDay[t]||(r.byDay[t]=0),r.byDay[t]+=o})}}),Object.keys(i).forEach(function(e){var t=i[e];Object.keys(t.byDay).forEach(function(e){t.byDayRelative[e]=t.byDay[e]/t.population*1e5})}),Object.keys(i).forEach(function(e){var t=i[e];Object.keys(t.byDay).forEach(function(e){var a=moment(e,"YYYY/MM/DD");t.byDay[e]>=o&&(t.reachedThreshold||(t.reachedThresholdAt=a,console.log(t.country+" reached threshold "+o+" with "+t.byDay[e]+" at "+a)),t.reachedThreshold=!0,t.byDay[e]>t.fullCaseCount&&(t.fullCaseCount=t.byDay[e]),(null==n||n>a)&&(n=a)),(null==r||r>a)&&(r=a)})}),Object.keys(i).forEach(function(e){var t=i[e];t.dayDiffToLowest=Math.round((t.reachedThresholdAt-r)/864e5)}),$("body").append("<textarea>"+JSON.stringify(i)+"</textarea>"),e(i,r,n,a)}})}})}function csvToArray(e,t=","){var a='(".*?"|[^"'+t+"]+)(?=s*"+t+"|s*$)",o=new RegExp(a,"g"),r=[],n=e.replace("\r","").split("\n");return n.forEach(function(a){var n=[];a[0]==t&&n.push(""),a.replace(o,function(e,t,a,o){return void 0!==t?n.push(t.replace(/\\'/g,"'")):void 0!==a?n.push(a.replace(/\\"/g,'"')):void 0!==o&&n.push(o),""}),new RegExp(t+"s*$").test(e)&&n.push(""),r.push(n)}),r}function setHideButton(e){"show"==e?($(this).attr("data-hide","show"),$(this).text("Show all")):($(this).attr("data-hide","hide"),$(this).text("Hide all"))}function setChartHiddenStatus(e){var t=$("#chart").highcharts();"hide"==e?($.each(t.series,function(e,t){console.log(t.name),t.setVisible(!1,!1)}),setHideButton("show")):($.each(t.series,function(e,t){console.log(t.name),t.setVisible(!0,!1)}),setHideButton("hide")),t.redraw()}function getChartOptions(e,t,a){var o=$("input[type=radio][name=scaling]:checked").val();return a="cases"==a?"Confirmed cases":"Deaths",{chart:{zoomType:"xy"},title:{text:""},yAxis:{type:o,title:{text:a}},xAxis:{labels:{align:"left",formatter:function(){return""}},plotLines:[{color:"black",value:e.toDate(),width:1,label:{formatter:function(){return"Threshold"}}}]},legend:{layout:"vertical",align:"right",verticalAlign:"middle"},tooltip:{headerFormat:"",useHtml:!0},plotOptions:{series:{label:{connectorAllowed:!1},pointStart:e.toDate()}},series:t,responsive:{rules:[{condition:{maxWidth:500},chartOptions:{legend:{layout:"horizontal",align:"center",verticalAlign:"bottom"}}}]}}}const THRESHOLD_CASES=50,THRESHOLD_DEATHS=10,DAYS_BEFORE_THRESHOLD=10;$(function(){$("#field-threshold-cases").val(THRESHOLD_CASES),$("#field-threshold-deaths").val(THRESHOLD_DEATHS),$("#field-days-before-threshold").val(DAYS_BEFORE_THRESHOLD),load()}),$("input[name=source], input[name=source-value], input[name=source-scaling], input[name=scaling], input[name=sorting]").change(function(){load()}),$(".threshold-option").change(function(){load()}),Highcharts.Point.prototype.tooltipFormatter=function(e){var t=this,a="cases"==t.dataType?"confirmed cases":"deaths",o=null==t.addedFromLast?"":"new "+a+": "+t.addedFromLast+"<br />",r=t.real.format("YYYY/MM/DD"),n="relative"==t.sourceScaling?" per 100 000 inhabitants<br>Total: "+t.total+" "+a+"<br>Population: "+t.region.population:"";return"<b>"+t.region.country+" </b> | Day "+t.daysSinceStart+"<br/>"+t.y.toFixed(0)+" "+a+n+"<br />"+o+"Offset: "+t.region.dayDiffToLowest+" days<br/>"+r},$("#toggle-series").click(function(){var e=$(this).attr("data-hide");setChartHiddenStatus(e)}),String.prototype.toColor=function(){for(var e=0,t=0;t<this.length;t++)e=this.charCodeAt(t)+((e<<5)-e);var a="#";for(t=0;t<3;t++){var o=e>>8*t&255;a+=("00"+o.toString(16)).substr(-2)}return a};