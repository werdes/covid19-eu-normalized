function load(){switch($("#loading-indicator").removeClass("d-none"),$("#threshold-cases").text($("#field-threshold-cases").val()),$("#threshold-deaths").text($("#field-threshold-deaths").val()),$("#days-before-threshold").text($("#field-days-before-threshold").val()),$("input[name=source]:checked").val()){case"john-hopkins-csse-confirmed":loadJHCSSEConfirmed(displayData);break;case"john-hopkins-csse-deaths":loadJHCSSEDeaths(displayData)}}function displayData(e,a,t){var o=new Array,r=new Date,s=[],n=parseInt($("#field-days-before-threshold").val());r.setDate(a.getDate()-n),console.log(a+" -> "+r),Object.keys(e).forEach(function(a){s.push(e[a])}),s.sort(function(e,a){return a.fullCaseCount-e.fullCaseCount}),s.forEach(function(e,a){if(e.reachedThreshold){var s=new Array,n=null;Object.keys(e.byDay).forEach(function(a){var o=1+Math.round((new Date(a)-e.reachedThresholdAt)/864e5),l=new Date(a);l.setDate(l.getDate()-e.dayDiffToLowest);var c=null==n?null:e.byDay[a]-n;l>=r&&s.push({x:l,real:new Date(a),daysSinceStart:o,region:e,dataType:t,y:e.byDay[a],addedFromLast:c}),n=e.byDay[a]}),o.push({name:e.country,data:s})}}),$("#loading-indicator").addClass("d-none"),Highcharts.chart("chart",getChartOptions(a,o))}function loadJHCSSEConfirmed(e){var a=parseInt($("#field-threshold-cases").val());loadJHCSSE(e,"https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv","cases",a)}function loadJHCSSEDeaths(e){var a=parseInt($("#field-threshold-deaths").val());loadJHCSSE(e,"https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv","deaths",a)}function loadJHCSSE(e,a,t,o){var r=null,s="([0-9]{1,2}/[0-9]{1,2}/[0-9]{1,2})\\w+",n={};$.get({url:a,cache:!0,complete:function(a){var l=csvToArray(a.responseText),c={},i=l[0];i.forEach(function(e,a){if(e.match(s)){var t=new Date(e),o=t.getFullYear()+"/"+("0"+(t.getMonth()+1)).slice(-2)+"/"+("0"+t.getDate()).slice(-2);c[o]=a}}),l.shift(),l.forEach(function(e,a){var t=e[1];n[t]||(n[t]={country:t,reachedThresholdAt:null,reachedThreshold:!1,dayDiffToLowest:0,fullCaseCount:0,byDay:{}});var o=n[t];Object.keys(c).forEach(function(a){var t=c[a],r=parseInt(e[t]);o.byDay[a]||(o.byDay[a]=0),o.byDay[a]+=r})}),Object.keys(n).forEach(function(e){var a=n[e];Object.keys(a.byDay).forEach(function(e){var t=new Date(e);a.byDay[e]>=o&&(a.reachedThreshold||(a.reachedThresholdAt=t,console.log(a.country+" reached threshold "+o+" with "+a.byDay[e]+" at "+t)),a.reachedThreshold=!0,a.byDay[e]>a.fullCaseCount&&(a.fullCaseCount=a.byDay[e]),(null==r||r<t)&&(r=t))})}),Object.keys(n).forEach(function(e){var a=n[e];a.dayDiffToLowest=Math.round((a.reachedThresholdAt-r)/864e5)}),e(n,r,t)}})}function csvToArray(e){var a=/(".*?"|[^",]+)(?=\s*,|\s*$)/g,t=[],o=e.replace("\r","").split("\n");return o.forEach(function(o){var r=[];","==o[0]&&r.push(""),o.replace(a,function(e,a,t,o){return void 0!==a?r.push(a.replace(/\\'/g,"'")):void 0!==t?r.push(t.replace(/\\"/g,'"')):void 0!==o&&r.push(o),""}),/,\s*$/.test(e)&&r.push(""),t.push(r)}),t}function getChartOptions(e,a){var t=$("input[type=radio][name=scaling]:checked").val();return{chart:{zoomType:"xy"},title:{text:""},yAxis:{type:t,title:{text:"confirmed cases"}},xAxis:{labels:{align:"left",formatter:function(){return""}},plotLines:[{color:"black",value:e,width:1,label:{formatter:function(){return"Threshold"}}}]},legend:{layout:"vertical",align:"right",verticalAlign:"middle"},tooltip:{headerFormat:"",useHtml:!0},plotOptions:{series:{label:{connectorAllowed:!1},pointStart:e}},series:a,responsive:{rules:[{condition:{maxWidth:500},chartOptions:{legend:{layout:"horizontal",align:"center",verticalAlign:"bottom"}}}]}}}const THRESHOLD_CASES=50,THRESHOLD_DEATHS=10,DAYS_BEFORE_THRESHOLD=10;$(function(){$("#field-threshold-cases").val(THRESHOLD_CASES),$("#field-threshold-deaths").val(THRESHOLD_DEATHS),$("#field-days-before-threshold").val(DAYS_BEFORE_THRESHOLD),load()}),$("input[name=source]").change(function(){load()}),$("input[name=scaling]").change(function(){load()}),$(".threshold-option").change(function(){load()}),Highcharts.Point.prototype.tooltipFormatter=function(e){var a=this,t="cases"==a.dataType?"confirmed cases":"deaths",o=null==a.addedFromLast?"":"new "+t+": "+a.addedFromLast+"<br />",r=a.real.getFullYear()+"/"+("0"+(a.real.getMonth()+1)).slice(-2)+"/"+("0"+a.real.getDate()).slice(-2);return"<b>"+a.region.country+" </b> | Day "+a.daysSinceStart+"<br/>"+a.y+" "+t+"<br />"+o+"Offset: "+a.region.dayDiffToLowest+" days<br/>"+r};