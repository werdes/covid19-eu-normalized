function load(){switch($("#loading-indicator").removeClass("d-none"),$("input[name=source]:checked").val()){case"isaac-lin":loadIsaacLin(displayData);break;case"john-hopkins-csse-confirmed":loadJHCSSEConfirmed(displayData);break;case"john-hopkins-csse-deaths":loadJHCSSEDeaths(displayData)}}function displayData(e,a,t){var o=new Array,n=[];Object.keys(e).forEach(function(a){n.push(e[a])}),n.sort(function(e,a){return a.fullCaseCount-e.fullCaseCount}),n.forEach(function(e,a){if(e.reachedThreshold){var n=new Array;Object.keys(e.byDay).forEach(function(a){var o=1+Math.round((new Date(a)-e.reachedThresholdAt)/864e5),s=new Date(a);s.setDate(s.getDate()-e.dayDiffToLowest),n.push({x:s,real:new Date(a),daysSinceStart:o,region:e,dataType:t,y:e.byDay[a]})}),o.push({name:e.country,data:n})}}),$("#loading-indicator").addClass("d-none"),Highcharts.chart("chart",getChartOptions(a,o))}function loadJHCSSEConfirmed(e){var a=parseInt($("#field-threshold-cases").val());loadJHCSSE(e,"https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Confirmed.csv","cases",a)}function loadJHCSSEDeaths(e){var a=parseInt($("#field-threshold-deaths").val());loadJHCSSE(e,"https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Deaths.csv","deaths",a)}function loadJHCSSE(e,a,t,o){var n=null,s="([0-9]{1,2}/[0-9]{1,2}/[0-9]{1,2})\\w+",r={};$.get({url:a,cache:!0,complete:function(a){var c=csvToArray(a.responseText),i={},l=c[0];l.forEach(function(e,a){if(e.match(s)){var t=new Date(e),o=t.getFullYear()+"/"+("0"+(t.getMonth()+1)).slice(-2)+"/"+("0"+t.getDate()).slice(-2);i[o]=a}}),c.shift(),c.forEach(function(e,a){var t=e[1];r[t]||(r[t]={country:t,reachedThresholdAt:null,reachedThreshold:!1,dayDiffToLowest:0,fullCaseCount:0,byDay:{}});var s=r[t];Object.keys(i).forEach(function(a){var t=i[a],r=parseInt(e[t]),c=new Date(a);s.byDay[a]||(s.byDay[a]=0),s.byDay[a]+=r,r>=o&&(s.reachedThreshold||(s.reachedThresholdAt=c),s.reachedThreshold=!0,r>s.fullCaseCount&&(s.fullCaseCount=r)),(null==n||n>c)&&(n=c)})}),Object.keys(r).forEach(function(e){var a=r[e];a.dayDiffToLowest=Math.round((a.reachedThresholdAt-n)/864e5)}),e(r,n,t)}})}function loadIsaacLin(e){var a=null,t=parseInt($("#field-threshold-cases").val());$.get({url:"https://raw.githubusercontent.com/BlankerL/DXY-COVID-19-Data/master/json/DXYArea-TimeSeries.json",cache:!0,dataType:"json",complete:function(o){var n={};o.responseJSON.forEach(function(e,o){if(e.countryEnglishName&&e.provinceEnglishName==e.countryEnglishName&&"Europe"==e.continentEnglishName){n[e.countryEnglishName]||(n[e.countryEnglishName]={country:e.countryEnglishName,reachedThresholdAt:null,reachedThreshold:!1,dayDiffToLowest:0,snapshots:new Array,fullCaseCount:0,byDay:{}});var s=n[e.countryEnglishName];if(s.snapshots.push(e),e.confirmedCount>=t){if(s.reachedThreshold=!0,null==s.reachedThresholdAt||s.reachedThresholdAt>new Date(e.updateTime)){var r=new Date(e.updateTime);s.reachedThresholdAt=r,(null==a||a>r)&&(a=r)}s.fullCaseCount<e.confirmedCount&&(s.fullCaseCount=e.confirmedCount)}}}),Object.keys(n).forEach(function(e){var t=n[e];t.dayDiffToLowest=Math.round((t.reachedThresholdAt-a)/864e5),t.reachedThreshold&&(t.snapshots.sort(function(e,a){return e.updateTime-a.updateTime}),t.snapshots.forEach(function(e){var a=new Date(e.updateTime),o=a.getFullYear()+"/"+("0"+(a.getMonth()+1)).slice(-2)+"/"+("0"+a.getDate()).slice(-2);t.byDay[o]||(t.byDay[o]=e.confirmedCount),t.byDay[o]<e.confirmedCount&&(t.byDay[o]=e.confirmedCount)}),t.snapshots=null)}),e(n,a,"cases")}})}function csvToArray(e){var a=/(".*?"|[^",]+)(?=\s*,|\s*$)/g,t=[],o=e.replace("\r","").split("\n");return o.forEach(function(o){var n=[];","==o[0]&&n.push(""),o.replace(a,function(e,a,t,o){return void 0!==a?n.push(a.replace(/\\'/g,"'")):void 0!==t?n.push(t.replace(/\\"/g,'"')):void 0!==o&&n.push(o),""}),/,\s*$/.test(e)&&n.push(""),t.push(n)}),t}function getChartOptions(e,a){return{chart:{zoomType:"xy"},title:{text:""},yAxis:{title:{text:"confirmed cases"}},xAxis:{labels:{align:"left",formatter:function(){return""}}},legend:{layout:"vertical",align:"right",verticalAlign:"middle"},tooltip:{headerFormat:"",useHtml:!0},plotOptions:{series:{label:{connectorAllowed:!1},pointStart:e}},series:a,responsive:{rules:[{condition:{maxWidth:500},chartOptions:{legend:{layout:"horizontal",align:"center",verticalAlign:"bottom"}}}]}}}const THRESHOLD_CASES=50,THRESHOLD_DEATHS=10;$(function(){$("#threshold-cases").text(THRESHOLD_CASES),$("#threshold-deaths").text(THRESHOLD_DEATHS),$("#field-threshold-cases").val(THRESHOLD_CASES),$("#field-threshold-deaths").val(THRESHOLD_DEATHS),loadJHCSSEConfirmed(displayData)}),$("input[name=source]").change(function(){load()}),$(".threshold-option").change(function(){load()}),Highcharts.Point.prototype.tooltipFormatter=function(e){var a=this,t="cases"==a.dataType?"confirmed cases":"deaths",o=a.real.getFullYear()+"/"+("0"+(a.real.getMonth()+1)).slice(-2)+"/"+("0"+a.real.getDate()).slice(-2);return"<b>"+a.region.country+" </b> | Day "+a.daysSinceStart+"<br/>"+a.y+" "+t+"<br />Offset: "+a.region.dayDiffToLowest+" days<br/>"+o};